<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- Bootstrap 5.3 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <div id="loader" class="modal fade bg-transparent" data-bs-backdrop="static">
    <div
      class="modal-dialog bg-transparend h-100 d-flex justify-content-center align-items-center"
    >
      <div
        class="spinner-border"
        style="width: 3rem; height: 3rem"
        role="status"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>
  <body>
    <div class="d-flex justify-content-end">
      <button id="add-dataset" type="button" class="btn btn-primary">
        Add Dataset <span><i class="bi bi-plus"></i></span>
      </button>
    </div>
    <form id="input-form">
      <div id="file-inputs">
        <h2>Datasets</h2>
        <div class="input-group mb-3">
          <span class="input-group-text">Description Index</span>
          <input
            type="number"
            min="0"
            value="0"
            name="index1"
            id="index1"
            class="form-control"
          />
          <input
            type="file"
            name="file1"
            id="file1"
            class="form-control w-50"
            aria-describedby="inputGroupFileAddon03"
            aria-label="Upload"
          />
        </div>
      </div>
      <div>
        <button type="submit" class="btn btn-outline-primary">Submit</button>
      </div>
    </form>

    <div>
      <button
        id="download-excel"
        type="button"
        class="btn btn-outline-success btn-lg"
        hidden
      >
        <span><i class="bi bi-filetype-xlsx"></i></span>
        <span><i class="bi bi-cloud-download"></i></span>
      </button>

      <button
        id="download-csv"
        type="button"
        class="btn btn-outline-success btn-lg"
        hidden
      >
        <span><i class="bi bi-filetype-csv"></i></span>
        <span><i class="bi bi-cloud-download"></i></span>
      </button>
    </div>
  </body>

  <script>
    let fileindex = 1;

    let reportData = null;

    const loader = new bootstrap.Modal(document.getElementById("loader"));
    const form = document.querySelector("#input-form");
    const xlsDownloadButton = document.getElementById("download-excel");
    const csvDownloadButton = document.getElementById("download-csv");

    form.addEventListener("submit", submitHandler);
    xlsDownloadButton.addEventListener("click", downloadHandler);
    xlsDownloadButton.fileType = "xlsx";
    csvDownloadButton.addEventListener("click", downloadHandler);
    csvDownloadButton.fileType = "csv";

    function getFilenameFromContentDisposition(header) {
      if (!header) return null;

      const match = header.match(/filename="?([^"]+)"?/);
      return match ? match[1] : null;
    }

    async function submitHandler(event) {
      event.preventDefault();

      loader.show();

      const formData = new FormData();

      const inputs = document.querySelector("#file-inputs");
      const fileInputs = inputs.querySelectorAll("input[type='file']");
      const indexInputs = inputs.querySelectorAll("input[type='number']");

      fileInputs.forEach((input) => {
        let fileInput = document.querySelector(`input#${input.id}`);
        formData.append("files", fileInput.files[0]);
      });

      indexInputs.forEach((input) => {
        let indexInput = document.querySelector(`input#${input.id}`);
        formData.append("indices", indexInput.value);
      });

      try {
        res = await fetch("/compute", {
          method: "POST",
          body: formData,
        });

        if (res.status === 200) {
          const data = await res.json();
          reportData = data.report;

          xlsDownloadButton.removeAttribute("hidden");
          csvDownloadButton.removeAttribute("hidden");

          loader.hide();
        }
      } catch (error) {
        console.log(error);
      }
    }

    async function downloadHandler(event) {
      try {
        res = await fetch("/export", {
          method: "POST",
          body: JSON.stringify({
            data: reportData,
            file_type: event.currentTarget.fileType,
          }),
          headers: {
            "Content-Type": "application/json",
          },
        });

        if (res.status === 200) {
          // You read the stream in a more advanced way
          // https://developer.mozilla.org/en-US/docs/Web/API/Streams_API/Using_readable_streams#consuming_a_fetch_using_asynchronous_iteration
          const blob = await res.blob();

          const header = res.headers.get("Content-Disposition");
          const filename = getFilenameFromContentDisposition(header);

          const fileUrl = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = fileUrl;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          link.remove();
          window.URL.revokeObjectURL(fileUrl);
        }
      } catch (error) {
        console.log(error);
      }
    }

    function addDataset() {
      fileindex += 1;

      const inputs = document.querySelector("#file-inputs");

      // Create div wrapper & set its class
      const wrapper = document.createElement("div");
      wrapper.setAttribute("class", "input-group mb-3");

      // Create span element & set attribute and text
      const description = document.createElement("span");
      description.setAttribute("class", "input-group-text");
      description.innerHTML = "Description Index";

      // Create index input sets is attributes
      const indexInput = document.createElement("input");
      indexInput.setAttribute("type", "number");
      indexInput.setAttribute("min", "0");
      indexInput.setAttribute("value", "0");
      indexInput.setAttribute("name", "index" + fileindex);
      indexInput.setAttribute("id", "index" + fileindex);
      indexInput.setAttribute("class", "form-control");

      // Create file input sets is attributes
      const fileInput = document.createElement("input");
      fileInput.setAttribute("type", "file");
      fileInput.setAttribute("name", "file" + fileindex);
      fileInput.setAttribute("id", "file" + fileindex);
      fileInput.setAttribute("class", "form-control w-50");
      fileInput.setAttribute("aria-describedby", "inputGroupFileAddon03");
      fileInput.setAttribute("class", "form-control w-50");
      fileInput.setAttribute("aria-label", "Upload");

      wrapper.appendChild(description);
      wrapper.appendChild(indexInput);
      wrapper.appendChild(fileInput);

      inputs.insertAdjacentElement("beforeend", wrapper);
    }

    document
      .querySelector("#add-dataset")
      .addEventListener("click", addDataset);
  </script>
</html>
